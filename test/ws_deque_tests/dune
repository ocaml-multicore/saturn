(test
 (name test_ws_deque)
 (libraries lockfree)
 (modules test_ws_deque))

;; multicorecheck tests

(alias
 (name default)
 (deps multicorecheck_ws_deque.exe))

(executable
 (name multicorecheck_ws_deque)
 (modules multicorecheck_ws_deque)
 (libraries qcheck multicorecheck.stm lockfree)
 (preprocess
  (pps ppx_deriving.show)))

(env
 (_
  (binaries
   (../check_error_count.exe as check_error_count))))

(rule
 (alias runtest)
 (deps multicorecheck_ws_deque.exe)
 (action
  (progn
   (bash
    "(./multicorecheck_ws_deque.exe --no-colors --verbose || echo 'test run triggered an error') | tee wsd-output.txt")
   (run
    %{bin:check_error_count}
    "lockfree/multicorecheck_ws_deque"
    1
    wsd-output.txt))))
