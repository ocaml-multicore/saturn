<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Htbl_unsafe (saturn.Saturn.Htbl_unsafe)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> ‚Äì <a href="../../index.html">saturn</a> &#x00BB; <a href="../index.html">Saturn</a> &#x00BB; Htbl_unsafe</nav><header class="odoc-preamble"><h1>Module <code><span>Saturn.Htbl_unsafe</span></code></h1><p>Optimized lock-free and resizable hash table.</p><p>The operations provided by this hash table are designed to work as building blocks of non-blocking algorithms. Specifically, the operation signatures and semantics are designed to allow building <a href="https://dl.acm.org/doi/10.1145/62546.62593">consensus protocols over arbitrary numbers of processes</a>.</p><p>üèéÔ∏è Single key reads with this hash table are actually wait-free rather than just lock-free. Internal resizing automatically uses all the threads that are trying to write to the hash table.</p></header><nav class="odoc-toc"><ul><li><a href="#api">API</a><ul><li><a href="#adding-bindings">Adding bindings</a></li><li><a href="#updating-bindings">Updating bindings</a></li><li><a href="#removing-bindings">Removing bindings</a></li><li><a href="#examining-contents">Examining contents</a></li></ul></li><li><a href="#examples">Examples</a></li></ul></nav><div class="odoc-content"><h2 id="api"><a href="#api" class="anchor"></a>API</h2><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> <span>(!'k, !'v) t</span></span></code></div><div class="spec-doc"><p>Represents a lock-free hash table mapping keys of type <code>'k</code> to values of type <code>'v</code>.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-hashed_type"><a href="#type-hashed_type" class="anchor"></a><code><span><span class="keyword">type</span> <span>'k hashed_type</span></span><span> = <span>(<span class="keyword">module</span> <span class="xref-unresolved">Stdlib</span>.Hashtbl.HashedType <span class="keyword">with</span> <span class="keyword">type</span> <span class="xref-unresolved">t</span> = <span class="type-var">'k</span>)</span></span></code></div><div class="spec-doc"><p>First-class module type abbreviation.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-create"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : 
  <span><span class="optlabel">?hashed_type</span>:<span><span class="type-var">'k</span> <a href="#type-hashed_type">hashed_type</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?min_buckets</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?max_buckets</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span class="type-var">'k</span>, <span class="type-var">'v</span>)</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>create ~hashed_type:(module Key) ()</code> creates a new empty lock-free hash table.</p><ul><li>The optional <code>hashed_type</code> argument can and usually should be used to specify the <code>equal</code> and <code>hash</code> operations on keys. Slow polymorphic equality <code>(=)</code> and slow polymorphic <span class="xref-unresolved" title="Stdlib.Hashtbl.seeded_hash"><code>seeded_hash (Bits64.to_int (Random.bits64 ()))</code></span> are used by default.</li><li>The default <code>min_buckets</code> is unspecified, and a given <code>min_buckets</code> may be adjusted by the implementation.</li><li>The default <code>max_buckets</code> is unspecified, and a given <code>max_buckets</code> may be adjusted by the implementation.</li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-hashed_type_of"><a href="#val-hashed_type_of" class="anchor"></a><code><span><span class="keyword">val</span> hashed_type_of : <span><span><span>(<span class="type-var">'k</span>, <span class="type-var">'v</span>)</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'k</span> <a href="#type-hashed_type">hashed_type</a></span></span></code></div><div class="spec-doc"><p><code>hashed_type_of htbl</code> returns a copy of the hashed type used when the hash table <code>htbl</code> was created.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-min_buckets_of"><a href="#val-min_buckets_of" class="anchor"></a><code><span><span class="keyword">val</span> min_buckets_of : <span><span><span>(<span class="type-var">'k</span>, <span class="type-var">'v</span>)</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>min_buckets_of htbl</code> returns the minimum number of buckets in the hash table <code>htbl</code>.</p><p>‚ÑπÔ∏è The returned value may not be the same as the one given to <a href="#val-create"><code>create</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-max_buckets_of"><a href="#val-max_buckets_of" class="anchor"></a><code><span><span class="keyword">val</span> max_buckets_of : <span><span><span>(<span class="type-var">'k</span>, <span class="type-var">'v</span>)</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>max_buckets_of htbl</code> returns the maximum number of buckets in the hash table <code>htbl</code>.</p><p>‚ÑπÔ∏è The returned value may not be the same as the one given to <a href="#val-create"><code>create</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-length"><a href="#val-length" class="anchor"></a><code><span><span class="keyword">val</span> length : <span><span><span>(<span class="type-var">'k</span>, <span class="type-var">'v</span>)</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>length htbl</code> returns the number of bindings in the hash table <code>htbl</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-find_opt"><a href="#val-find_opt" class="anchor"></a><code><span><span class="keyword">val</span> find_opt : <span><span><span>(<span class="type-var">'k</span>, <span class="type-var">'v</span>)</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'k</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'v</span> option</span></span></code></div><div class="spec-doc"><p>Looking up bindings</p><p><code>find_opt htbl key</code> returns <code>Some</code> of the current binding of <code>key</code> in the hash table <code>htbl</code> or <code>None</code> if it does not exist.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-find_exn"><a href="#val-find_exn" class="anchor"></a><code><span><span class="keyword">val</span> find_exn : <span><span><span>(<span class="type-var">'k</span>, <span class="type-var">'v</span>)</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'k</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'v</span></span></code></div><div class="spec-doc"><p><code>find_exn htbl key</code> returns the current binding of <code>key</code> in the hash table <code>htbl</code> or raises <code>Not_found</code> if no such binding exists.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <code>Not_found</code> <p>if no binding of <code>key</code> exists in the hash table <code>htbl</code>.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-mem"><a href="#val-mem" class="anchor"></a><code><span><span class="keyword">val</span> mem : <span><span><span>(<span class="type-var">'k</span>, <span class="type-var">'v</span>)</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'k</span> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>mem htbl key</code> determines whether the hash table <code>htbl</code> has a binding for the <code>key</code>.</p></div></div><h3 id="adding-bindings"><a href="#adding-bindings" class="anchor"></a>Adding bindings</h3><div class="odoc-spec"><div class="spec value anchored" id="val-try_add"><a href="#val-try_add" class="anchor"></a><code><span><span class="keyword">val</span> try_add : <span><span><span>(<span class="type-var">'k</span>, <span class="type-var">'v</span>)</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'k</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'v</span> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>try_add htbl key value</code> tries to add a new binding of <code>key</code> to <code>value</code> to the hash table <code>htbl</code>. Returns <code>true</code> on success and <code>false</code> if the hash table already contains a binding for <code>key</code>.</p></div></div><h3 id="updating-bindings"><a href="#updating-bindings" class="anchor"></a>Updating bindings</h3><div class="odoc-spec"><div class="spec value anchored" id="val-try_set"><a href="#val-try_set" class="anchor"></a><code><span><span class="keyword">val</span> try_set : <span><span><span>(<span class="type-var">'k</span>, <span class="type-var">'v</span>)</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'k</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'v</span> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>try_set htbl key value</code> tries to update an existing binding of <code>key</code> to <code>value</code> in the hash table <code>htbl</code>. Returns <code>true</code> on success and <code>false</code> if the hash table does not contain a binding for <code>key</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-try_compare_and_set"><a href="#val-try_compare_and_set" class="anchor"></a><code><span><span class="keyword">val</span> try_compare_and_set : <span><span><span>(<span class="type-var">'k</span>, <span class="type-var">'v</span>)</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'k</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'v</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'v</span> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>try_compare_and_set htbl key before after</code> tries to update an existing binding of <code>key</code> from the <code>before</code> value to the <code>after</code> value in the hash table <code>htbl</code>. Returns <code>true</code> on success and <code>false</code> if the hash table does not contain a binding of <code>key</code> to the <code>before</code> value.</p><p>‚ÑπÔ∏è The values are compared using physical equality, i.e. the <code>==</code> operator.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_exn"><a href="#val-set_exn" class="anchor"></a><code><span><span class="keyword">val</span> set_exn : <span><span><span>(<span class="type-var">'k</span>, <span class="type-var">'v</span>)</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'k</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'v</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'v</span></span></code></div><div class="spec-doc"><p><code>set_exn htbl key after</code> tries to update an existing binding of <code>key</code> from some <code>before</code> value to the <code>after</code> value in the hash table <code>htbl</code>. Returns the <code>before</code> value on success or raises <code>Not_found</code> if no such binding exists.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <code>Not_found</code> <p>if no binding of <code>key</code> exists in the hash table <code>htbl</code>.</p></li></ul></div></div><h3 id="removing-bindings"><a href="#removing-bindings" class="anchor"></a>Removing bindings</h3><div class="odoc-spec"><div class="spec value anchored" id="val-try_remove"><a href="#val-try_remove" class="anchor"></a><code><span><span class="keyword">val</span> try_remove : <span><span><span>(<span class="type-var">'k</span>, <span class="type-var">'v</span>)</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'k</span> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>try_remove htbl key</code> tries to remove a binding of <code>key</code> from the hash table <code>htbl</code>. Returns <code>true</code> on success and <code>false</code> if the hash table does not contain a binding for <code>key</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-try_compare_and_remove"><a href="#val-try_compare_and_remove" class="anchor"></a><code><span><span class="keyword">val</span> try_compare_and_remove : <span><span><span>(<span class="type-var">'k</span>, <span class="type-var">'v</span>)</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'k</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'v</span> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>try_compare_and_remove htbl key before</code> tries to remove a binding of <code>key</code> to the <code>before</code> value from the hash table <code>htbl</code>. Returns <code>true</code> on success and <code>false</code> if the hash table does not contain a binding of <code>key</code> to the <code>before</code> value.</p><p>‚ÑπÔ∏è The values are compared using physical equality, i.e. the <code>==</code> operator.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-remove_exn"><a href="#val-remove_exn" class="anchor"></a><code><span><span class="keyword">val</span> remove_exn : <span><span><span>(<span class="type-var">'k</span>, <span class="type-var">'v</span>)</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'k</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'v</span></span></code></div><div class="spec-doc"><p><code>remove_exn htbl key</code> tries to remove a binding of <code>key</code> to some <code>before</code> value from the hash table <code>htbl</code>. Returns the <code>before</code> value on success or raises <code>Not_found</code> if no such binding exists.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <code>Not_found</code> <p>if no binding of <code>key</code> exists in the hash table <code>htbl</code>.</p></li></ul></div></div><h3 id="examining-contents"><a href="#examining-contents" class="anchor"></a>Examining contents</h3><div class="odoc-spec"><div class="spec value anchored" id="val-to_seq"><a href="#val-to_seq" class="anchor"></a><code><span><span class="keyword">val</span> to_seq : <span><span><span>(<span class="type-var">'k</span>, <span class="type-var">'v</span>)</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span class="type-var">'k</span> * <span class="type-var">'v</span>)</span> <span class="xref-unresolved">Stdlib</span>.Seq.t</span></span></code></div><div class="spec-doc"><p><code>to_seq htbl</code> takes a snapshot of the bindings in the hash table <code>htbl</code> and returns them as an association sequence.</p><p>üêå This is a linear-time operation.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-remove_all"><a href="#val-remove_all" class="anchor"></a><code><span><span class="keyword">val</span> remove_all : <span><span><span>(<span class="type-var">'k</span>, <span class="type-var">'v</span>)</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span class="type-var">'k</span> * <span class="type-var">'v</span>)</span> <span class="xref-unresolved">Stdlib</span>.Seq.t</span></span></code></div><div class="spec-doc"><p><code>remove_all htbl</code> takes a snapshot of the bindings in the hash table <code>htbl</code>, removes the bindings from the hash table, and returns the snapshot as an association sequence.</p><p>üêå This is a linear-time operation.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-find_random_exn"><a href="#val-find_random_exn" class="anchor"></a><code><span><span class="keyword">val</span> find_random_exn : <span><span><span>(<span class="type-var">'k</span>, <span class="type-var">'v</span>)</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'k</span></span></code></div><div class="spec-doc"><p><code>find_random_exn htbl</code> tries to find a random binding from the hash table <code>htbl</code> and returns the key of the binding or raises <code>Not_found</code> if the hash table is empty.</p><p>üêå This is an expected constant-time operation with worst-case linear-time complexity.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <code>Not_found</code> <p>if the hash table <code>htbl</code> is empty.</p></li></ul></div></div><h2 id="examples"><a href="#examples" class="anchor"></a>Examples</h2><p>An example top-level session:</p><pre class="language-ocaml"><code># module Htbl = Saturn.Htbl
module Htbl = Saturn.Htbl

# let t : (int, string) Htbl.t =
    Htbl.create
      ~hashed_type:(module Int) ()
val t : (int, string) Htbl.t = &lt;abstr&gt;

# Htbl.try_add t 42 &quot;The answer&quot;
- : bool = true

# Htbl.try_add t 101 &quot;Basics&quot;
- : bool = true

# Htbl.find_exn t 42
- : string = &quot;The answer&quot;

# Htbl.try_add t 101 &quot;The basics&quot;
- : bool = false

# Htbl.remove_all t |&gt; List.of_seq
- : (int * string) list = [(101, &quot;Basics&quot;); (42, &quot;The answer&quot;)]</code></pre><p>The lockfree bag (see <a href="../Bag/index.html"><code>Saturn.Bag</code></a>) is implemented using this hash table.</p></div></body></html>
